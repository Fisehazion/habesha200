<script>
  // Force Identity widget init and CMS render
  if (window.netlifyIdentity) {
    netlifyIdentity.init();
  }
  netlifyIdentity.on('init', () => {
    window.CMS.init({
      config: {
        backend: { name: "git-gateway", branch: "main" },
        media_folder: "images/uploads",
        public_folder: "/images/uploads",
        collections: [
          {
            name: "blog",
            label: "Blog Posts",
            folder: "content/blog",
            create: true,
            slug: "{{year}}-{{month}}-{{day}}-{{slug}}",
            fields: [
              { label: "Title", name: "title", widget: "string" },
              { label: "Date", name: "date", widget: "datetime" },
              { label: "Excerpt", name: "excerpt", widget: "text" },
              { label: "Body", name: "body", widget: "markdown" },
              { label: "YouTube Link", name: "video_link", widget: "string", required: false }
            ]
          }
        ]
      }
    });
  });

  // Fallback: Show login button if widget hangs (after 3 seconds)
  setTimeout(() => {
    if (document.querySelector('.nc-root') || !document.body.innerHTML.includes('netlify-identity')) {
      document.body.innerHTML = `
        <div style="text-align:center; padding:40px; font-family: Arial;">
          <h2>Content Manager Dashboard</h2>
          <p>Loading... If stuck, <a href="https://app.netlify.com/sites/behabeshawikana/identity/users" target="_blank">check Identity users</a>.</p>
          <button onclick="netlifyIdentity.open()" style="background: #1a202c; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Login with Netlify Identity</button>
        </div>
      `;
    }
  }, 3000);
</script>